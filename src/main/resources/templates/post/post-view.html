<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>레시피 상세 보기</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <style>
        .image-container {
            position: relative;
            width: 100%;
            height: 400px; /* 원하는 높이로 설정 */
            overflow: hidden;
            background-color: #f8f9fa; /* 이미지가 없는 경우 대비 */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cropped-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-height: 100%;
            min-width: 100%;
            object-fit: cover; /* 이미지 비율 유지하면서 컨테이너 채우기 */
        }
        /* 제목 스타일 */
        .card-title {
            font-size: 2rem; /* 제목 크기 */
            font-weight: bold; /* 굵은 글씨 */
            color: #333333; /* 어두운 회색 톤 */
            margin-bottom: 1rem; /* 제목과 콘텐츠 간 간격 */
        }

        /* 콘텐츠 스타일 */
        .card-content {
            font-size: 1rem; /* 기본 텍스트 크기 */
            line-height: 1.8; /* 줄 간격 */
            color: #AAAAAA; /* 약간 밝은 회색 톤 */
            margin-bottom: 1rem; /* 아래 여백 */
        }

        .square-image {
            width: 100%;
            aspect-ratio: 1 / 1; /* 정사각형 비율 유지 */
            object-fit: cover;   /* 넘치는 부분 자르기 */
            object-position: center; /* 중앙 정렬 */
        }
    </style>
</head>
<body class="bg-light">

    <div class="container mt-5 mb-5">
        <div class="row justify-content-center">

            <!-- 제목 및 소개 카드 -->
            <div class="col-md-12">
                <div class="card shadow-sm mb-1">
                    <div class="card-body">

                        <!-- 내부 콘텐츠 md-8로 줄이고 가운데 정렬 -->
                        <div class="row justify-content-center">
                            <div class="col-md-8">

                                <!-- 제목 및 소개 -->
                                <div class="image-container mb-4">
                                    <img th:src="${post.mainImageS3URL}" alt="메인 이미지" class="cropped-image w-100">
                                </div>

                                <!-- 레시피 제목 -->
                                <h2 class="card-title" th:text="${post.title}">레시피 제목</h2>

                                <!-- 요리 소개 -->
                                <p class="card-content" th:text="${post.content}">요리 소개</p>

                                <!-- 작성자 및 조회수 -->
                                <div class="d-flex justify-content-between text-muted small mb-3">
                                    <span class="author">작성자:
                                        <span th:text="${post.username != null and post.username != null ? post.username : '탈퇴한 회원'}">
                                            작성자 이름
                                        </span>
                                    </span>
                                    <span class="views">조회수: <span th:text="${post.viewCount}">0</span></span>
                                </div>

                                <!-- 좋아요 버튼 -->
                                <div class="text-center mt-4">
                                    <button class="btn btn-outline-danger" id="like-button" th:data-post-id="${post.id}">
                                        ❤️ 좋아요
                                    </button>
									<p>Post ID: <span th:text="${post.id}"></span></p>

                                    <!-- 좋아요 수 표시 -->
                                    <p class="mt-2 mb-0 text-muted small">
                                        좋아요 수: <span id="like-count" th:text="${post.likeCount}">0</span>
                                    </p>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 재료 정보 및 요리 순서 카드 -->
            <div class="col-md-12">
                <div class="card shadow-sm mb-1">
                    <div class="card-body">
                        <!-- 재료 정보 -->
                        <h4 class="mb-3">재료 정보</h4>
                        <ul id="ingredient-list" class="list-group mb-4"></ul>
                    </div>
                </div>

                <div class="card shadow-sm mb-1">
                    <div class="card-body">
                        <!-- 조리 순서 -->
                        <h4 class="mb-3">조리 순서</h4>
                        <div id="instruction-list"></div>

                        <a href="/recipes" class="btn btn-secondary btn-block mt-4">목록으로 돌아가기</a>
                    </div>
                </div>
            </div>

        </div>
    </div>


<!-- 숨겨진 div로 JSON 데이터를 저장 -->
<div id="ingredients-json" th:utext="${post.ingredients}" style="display:none;"></div>
<div id="instructions-json" th:utext="${post.instructions}" style="display:none;"></div>

<script>
	$(document).ready(function() {
	    let postId = $('#like-button').data('post-id');
	
	    console.log("postId: ", postId);  // 값 확인
	
	    if (!postId) {
	        console.error("postId가 존재하지 않습니다.");
	        return;
	    }
	
	    // ✅ 현재 좋아요 수 가져오기
	    $.get(`/api/v1/likes/${postId}`, function(response) {
	        $('#like-count').text(response.likeCount);
	    });
	
	    $('#like-button').on('click', function() {
	        let likeCountElement = $('#like-count');
	        let currentCount = parseInt(likeCountElement.text(), 10) || 0; 
	
	        // ✅ UI 즉시 반영
	        likeCountElement.text(currentCount + 1);
	
	        $.ajax({
	            url: '/api/v1/likes',
	            type: 'POST',
	            contentType: 'application/json',
	            data: JSON.stringify({ postId: postId }), // ✅ userId 없이 요청
	            success: function(response) {
	                likeCountElement.text(response.likeCount); // 최신 값 적용
	            },
	            error: function(xhr, status, error) {
	                console.error('좋아요 처리 중 오류 발생:', error);
	                likeCountElement.text(currentCount); // 실패 시 원래 값으로 복구
	            }
	        });
	    });
	});


    $(document).ready(function() {
        // 숨겨진 div에서 JSON 데이터 가져오기
        const ingredientsJson = $('#ingredients-json').text();
        const instructionsJson = $('#instructions-json').text();

        const ingredients = JSON.parse(ingredientsJson);
        const instructions = JSON.parse(instructionsJson);

        // 재료 리스트 렌더링
        ingredients.forEach(ingredient => {
            $('#ingredient-list').append(`
                <li class="list-group-item">
                    ${ingredient.name} - ${ingredient.quantity}${ingredient.unit}
                </li>
            `);
        });

        // 조리 순서 렌더링
        instructions.forEach((step, index) => {
            // 이미지가 있는 경우와 없는 경우를 구분하여 처리
            const imageSection = step.imageUrl
                ? `<div class="col-md-4 text-center">
                <img src="${step.imageUrl}" alt="Step Image" class="img-fluid rounded square-image">
           </div>`
                : '';

            $('#instruction-list').append(`
        <div class="row mb-4">
            <!-- 텍스트 부분 -->
            <div class="${step.imageUrl ? 'col-md-8' : 'col-md-12'}">
                <h5 class="fw-bold">Step ${index + 1}</h5>
                <p>${step.description}</p>
            </div>

            ${imageSection}
        </div>
    `);
        });
    });
</script>
</body>
</html>