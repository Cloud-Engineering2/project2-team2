<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>로그인</title>

    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/register.css" rel="stylesheet">
    
</head>
<body class="d-flex align-items-center py-4 bg-body-tertiary">


<div class="form-signin w-100 m-auto">
<h3 class="h3 mb-3 fw-normal">로그인</h3>

    <form id="loginForm">
      
   	<div class="form-floating mb-3">
   	<label for="username">유저이름</label>
      <input type="text" class="form-control" id="username" name="username" placeholder="이름을 입력해주세요" required>      
    </div>
    
     <div class="form-floating mb-3">
       <label for="password">비밀번호</label>
      <input type="password" class="form-control" id="password"  name="password" placeholder="비밀번호를 입력해주세요.">
    </div>
    
    <button class="btn btn-primary w-100 py-2 mt-5" type="submit">로그인</button>
  
    
    </form>
 </div>   
    



    <script>
    
        // 폼 제출 이벤트 처리
        document.getElementById('loginForm').addEventListener('submit', function (e) {
            e.preventDefault(); // 기본 폼 제출 동작을 막음

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // JSON 데이터로 변환
            const data = {
                username: username,
                password: password
            };

            // Fetch API로 로그인 요청
            fetch('/user/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data) // JSON 문자열로 변환하여 전송
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('로그인 실패');
                    }

                    // 1. Authorization 헤더에서 토큰 추출
                    const authHeader = response.headers.get('Authorization');  // 'Authorization' 헤더 가져오기
                    const token = authHeader ? authHeader.replace('Bearer ', '') : null;  // 'Bearer ' 제거 후 토큰만 추출

                    // 2. 본문 파싱
                    return response.json().then(data => ({ data, token }));
                })
                .then(({ data, token }) => {
                    console.log('응답 데이터:', data);
                    console.log('추출한 토큰:', token);

                    if (data.message === "로그인 성공!" && token) {
                        localStorage.setItem('token', token);  // 토큰 저장
                        window.location.href = '/';  // 리다이렉트
                    } else {
                        alert('로그인 실패: 토큰이 없습니다.');
                    }
                })
                .catch(error => {
                    console.error('로그인 요청 중 오류 발생:', error);
                    alert('로그인 요청 중 오류가 발생했습니다.');
                });
        });
    </script>

<!-- Bootstrap 5 JavaScript Bundle (with Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<!-- Bootstrap 4 JavaScript (without bundle) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</body>
</html>
