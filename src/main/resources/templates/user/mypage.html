<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<style>

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 25px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 25px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 4px;
    bottom: 3.5px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: green;
}

input:checked + .slider:before {
    transform: translateX(25px);
}

</style>
<body>
<div th:replace="~{layout/header :: header}">Header</div>
   
    <h1>마이페이지</h1>
    <!-- <p id="username"></p> -->
    
    <p id="email"></p>
    <p id="createdDate"></p>

<div>
    <label for="username">사용자아이디</label>
    <input type="text" id="username" th:value="${username}" readonly>
</div>

<div>
    <label for="email">이메일</label>
    <input type="text" id="email" th:value="${email}" readonly>
</div>

<div>
    <label for="createdDate">가입한날</label>
    <input type="text" id="createdDate" th:value="${createdDate}" readonly>
</div>


	<button id="editBtn" class="btn btn-primary">수정하기</button>
 
	<script>
	document.addEventListener("DOMContentLoaded", function () {
	    const token = localStorage.getItem("token");

	    if (!token) {
	        alert("로그인이 필요합니다.");
	        window.location.href = "/user/login"; // 로그인 페이지로 리다이렉트
	        return;
	    }

	    fetch("/api/mypage", {
	        method: "GET",
	        headers: {
	            "Authorization": "Bearer " + token // Bearer 형식으로 토큰을 추가
	        }
	    })
	    .then(response => {
	        if (!response.ok) {
	            return response.text().then(text => {
	                console.error("Error response:", text); // 응답 내용 출력
	                console.error("Response status:", response.status); // 응답 상태 코드 출력
	                throw new Error('응답이 정상적이지 않습니다.');
	            });
	        }
	        return response.json(); // 정상적인 응답은 JSON으로 처리
	    })
	    .then(data => {
	        console.log("Data received:", data); // 데이터 출력
	        if (data.error) {
	            console.error('Error:', data.error);
	            alert('로그인 정보가 유효하지 않습니다. 다시 로그인해주세요.');
	            localStorage.removeItem("token"); // 토큰 삭제
	            window.location.href = "/user/login"; // 로그인 페이지로 이동
	        } else {
	           /*  // 사용자 정보 표시
	            document.getElementById("username").innerText = `사용자 ID: ${data.username}`;
	            document.getElementById("email").innerText = `이메일: ${data.email}`;
	            document.getElementById("createdDate").innerText = `가입한날: ${data.createdDate}`; */
	        	// 사용자 정보 표시 (input에 값 설정)
	            console.log("Username:", data.username); 
	            document.getElementById("username").value = data.username;
	            document.getElementById("email").value = data.email;
	            document.getElementById("createdDate").value = data.createdDate;

	        }
	    })
	    .catch(error => {
	        console.error('Error:', error); // 오류 로그
	        alert("문제가 발생했습니다. 다시 로그인해주세요.");
	        localStorage.removeItem("token"); // 토큰 삭제
	        window.location.href = "/user/login"; // 로그인 페이지로 이동
	    });
	    
	    
	    
	 // 수정 버튼 클릭 이벤트
	    document.getElementById("updateBtn").addEventListener("click", function () {
	        const token = localStorage.getItem("token");

	        if (!token) {
	            alert("로그인이 필요합니다.");
	            return;
	        }

	        const updatedData = {
	            username: document.getElementById("username").value,
	            email: document.getElementById("email").value
	        };

	        fetch("/api/mypage", {
	            method: "PUT",
	            headers: {
	                "Content-Type": "application/json",
	                "Authorization": "Bearer " + token
	            },
	            body: JSON.stringify(updatedData)
	        })
	        .then(response => response.json())
	        .then(data => {
	            alert("정보가 성공적으로 수정되었습니다!");
	            console.log("Updated User:", data);
	        })
	        .catch(error => {
	            console.error("Error:", error);
	            alert("정보 수정에 실패했습니다.");
	        });
	    });

	 

	});

	</script>
	
	<script src="/js/common.js"></script>
</body>
</html>
